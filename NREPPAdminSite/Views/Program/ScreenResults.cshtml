@model NREPPAdminSite.Models.ScreeningModel

@{
    ViewBag.Title = "Screening Results";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Screening Results</h2>


@functions{
    string MeasuresList(int OutcomeId)
    {
        string outValue = "";
        foreach(NREPPAdminSite.Models.OutcomeMeasure measure in Model.Outcomes.OutcomesMeasures) // Use LINQ for this
        {
            if (measure.OutcomeId == OutcomeId)
                outValue += measure.OutcomeMeasureName + "; ";
        }

        outValue = outValue.Trim();
        if (outValue.Length > 0)
            return outValue.Substring(0, outValue.Length - 1);
        else return outValue;
        
    }

    string PopList(int OutcomeId)
    {
        string outValue = "";
        foreach (NREPPAdminSite.Models.OutcomeMeasure measure in Model.Outcomes.OutcomesMeasures) // Use LINQ for this
        {
            if (measure.OutcomeId == OutcomeId)
                outValue += measure.PopDescription + "; ";
        }

        outValue = outValue.Trim();
        if (outValue.Length > 0)
            return outValue.Substring(0, outValue.Length - 1);
        else return outValue;

    }

    string StudyList(int OutcomeId)
    {
        string outValue = "";
        foreach (NREPPAdminSite.Models.OutcomeMeasure measure in Model.Outcomes.OutcomesMeasures) // Use LINQ for this
        {
            if (measure.OutcomeId == OutcomeId)
                outValue += "Study " + measure.StudyId.ToString() + "; ";
        }

        outValue = outValue.Trim();
        if (outValue.Length > 0)
            return outValue.Substring(0, outValue.Length - 1);
        else return outValue;

    }

    string getReference(List<NREPPAdminSite.Models.RCDocument> docs, int inDocId)
    {

        foreach (NREPPAdminSite.Models.RCDocument d in docs)
            if (d.DocId == inDocId)
                return d.Reference;

        return "Error";
    }

    string getPubYear(List<NREPPAdminSite.Models.RCDocument> docs, int inDocId)
    {

        foreach (NREPPAdminSite.Models.RCDocument d in docs)
            if (d.DocId == inDocId)
                return d.PubYear.ToString();

        return "Error";
    }
    
    
    
    NREPPAdminSite.Models.Study getStudy(int StudyID)
    {
        NREPPAdminSite.Models.Study study;
        IEnumerable<NREPPAdminSite.Models.Study> studies = Model.StudyDocuments.Where(s => s.Id == StudyID);
        if (Model.StudyDocuments.Where(s => s.Id == StudyID).Count() > 0)
            study = Model.StudyDocuments.Where(s => s.Id == StudyID).First();
        else return new NREPPAdminSite.Models.Study();

        return study;
        //return Model.StudyDocuments.Where(s => s.Id == StudyID).First();
    }
    
    string getAnswerText(List<NREPPAdminSite.Models.Answer> AnswerList, int inId)
    {
        foreach (NREPPAdminSite.Models.Answer anAnswer in AnswerList)
        {
            if (anAnswer.AnswerId == inId)
                return anAnswer.LongAnswer;
        }
                
        return "";
    }

    string getShortAnswerText(List<NREPPAdminSite.Models.Answer> AnswerList, int inId)
    {
        foreach (NREPPAdminSite.Models.Answer anAnswer in AnswerList)
        {
            if (anAnswer.AnswerId == inId)
                return anAnswer.ShortAnswer;
        }

        return "";
    }
    
    
    string isChecked(bool trueValue)
    {
        if (trueValue)
            return "checked";
        else return "";
    }
}
<br /><br />
<div id="screening" class="table-responsive">
    <table class="table">
        <tr>
            <th>Study ID</th>
            <th>Reference</th>
            <th>Year of Publication</th>
            <th>Found in Lit Search</th>
            <th>Exclusion 1</th>
            <th>Exclusion 2</th>
            <th>Exclusion 3</th>
            <th>Study Design</th>
            <th>Reccomend Review</th>
        </tr>

        @foreach (NREPPAdminSite.Models.Study study in Model.StudyDocuments)
        {
            <tr>
                <td class="withborder">@study.StudyId</td>
                <td class="withborder">
                    @Html.ActionLink(getReference(Model.TheDocuments.ToList(), study.DocumentId)
                    , "GetFile", "Admin", new { FileId = study.DocumentId }, null)
                </td>
                <td class="withborder">@getPubYear(Model.TheDocuments.ToList(), study.DocumentId)</td>
                <td class="withborder"><input type="checkbox" checked="@isChecked(study.inLitSearch)" disabled /> </td>
                <td class="withborder">@getAnswerText(Model.Exclusions.ToList(), study.Exclusion1)</td>
                <td class="withborder">@getAnswerText(Model.Exclusions.ToList(), study.Exclusion2)</td>
                <td class="withborder">@getAnswerText(Model.Exclusions.ToList(), study.Exclusion3)</td>
                <td class="withborder">@getAnswerText(Model.StudyDesigns.ToList(), study.StudyDesign)</td>
                <td class="withborder"><input type="checkbox" checked="@isChecked(study.RecommendReview)" disabled /></td>
            </tr>
        }
    </table>
</div>

<br /><br />
<div id="screening">
    <table>
        <tr>
            <th colspan="5">Outcomes</th>
        </tr>
        <tr>
            <th class="withborder">Reported Effect</th>
            <th class="withborder">List Source of Reported Effect</th>
            <th class="withborder">General Description</th>
            <th class="withborder">Instrument/Source</th>
            <th class="withborder">Taxonomy Outcome</th>
            <th class="withborder">Study #</th>
            <th class="withborder">Article Reference</th>
            <th class="withborder">Assessment period to be rated</th>
            <th>Longest follow-up</th>
            <th>Full sample or subgroup</th>
            <th>SAMHSA-Related Population</th>
            <th>Describe Evaluated Population</th>
            <th>SAMHSA-Related Outcome</th>
            <th>Effect Size Reported</th>
            <th>Recommend For Review</th>
        </tr>
        @foreach (NREPPAdminSite.Models.OutcomeMeasure measure in Model.Outcomes.OutcomesMeasures)
        {
            <tr>
                <td class="withborder">@measure.OutcomeMeasureName</td>
                <td class="withborder">@measure.EffectSource</td>
                <td class="withborder">@measure.GeneralDescription</td>
                <td class="withborder">@measure.InstrumentSource</td>
                <td class="withborder">@getShortAnswerText(Model.TaxonomyOutcomes.ToList(), @measure.TaxOutcome)</td>
                <td class="withborder">Study #@measure.StudyId</td>
                <td class="withborder">@getReference(Model.TheDocuments.ToList(), @measure.DocumentId)</td>
                <td class="withborder">@getAnswerText(Model.AssessmentPd.ToList(), @measure.AssessmentPd)</td>
                <td class="withborder">@getAnswerText(Model.LongestFollowup.ToList(), @measure.LongestFollowup)</td>
                <td class="withborder">@getAnswerText(Model.FullSample.ToList(), @measure.FullSample)</td>
                <td class="withborder">@getAnswerText(Model.SAMHSAPops.ToList(), @measure.SAMHSAPop)</td>
                <td class="withborder">@measure.PopDescription</td>
                <td class="withborder">@getAnswerText(Model.SAMHSAOutcomes.ToList(), @measure.SAMHSAOutcome)</td>
                <td class="withborder">@getAnswerText(Model.EffectReports.ToList(), @measure.EffectReport)</td>
                <td class="withborder">@Html.CheckBox("chk" + @measure.Id, @measure.RecommendReview, new { disabled = "disabled" })</td>
            </tr>
        }
    </table>
</div>

<br /><br />


<div class="screening-form">
    @using (Html.BeginForm("SaveNotes", "Program"))
    {
        @Html.HiddenFor(m => m.TheIntervention.Id);
        @Html.HiddenFor(m => m.TheIntervention.SubmitterId);
        @Html.HiddenFor(m => m.TheIntervention.StatusId);
        @Html.HiddenFor(m => m.TheIntervention.ProgramType);
        @Html.HiddenFor(m => m.TheIntervention.Title)
        @Html.HiddenFor(m => m.TheIntervention.FromLitSearch)
        @Html.HiddenFor(m => m.TheIntervention.FullDescription)
        @Html.HiddenFor(m => m.TheIntervention.SubmitterId)
        @Html.HiddenFor(m => m.TheIntervention.UpdatedDate)
        @Html.HiddenFor(m => m.TheIntervention.Acronym)
        
        @Html.Hidden("Redirect", "ScreenResults")
        
        <br /><span><strong>Notes:</strong> </span><br />
        @Html.TextAreaFor(m => m.TheIntervention.ScreeningNotes)<br />
        
        <br /><input type="submit" value="Save Notes" class="btn btn-primary" />
        <br />
        <br /> @Html.ActionLink("Mark Complete or Return to Review Coordinator", "Assignment", new { InvId = Model.TheIntervention.Id });
    }
</div>

<script type="text/javascript">
    var thisIsAThing = 5;
    var currentStudy = new Array();
    var currentOutcomes = new Array();

    function makeRecord(Id, StudyId, Reference, inLitSearch, Exclusion1, Exclusion2, Exclusion3, StudyDesign, BaselineEquiv,
        UseMultivariate, SAMSHARelated, AuthorQueryNeeded, RecommendReview, Notes, DocumentId) {
        var anObject = {};

        anObject.Id = Id;
        anObject.StudyId = StudyId;
        anObject.Reference = Reference;
        anObject.inLitSearch = inLitSearch != "False";
        anObject.Exclusion1 = Exclusion1;
        anObject.Exclusion2 = Exclusion2;
        anObject.Exclusion3 = Exclusion3;
        anObject.StudyDesign = StudyDesign;
        anObject.BaselineEquiv = BaselineEquiv;
        anObject.UseMultivariate = UseMultivariate != "False";
        anObject.SAMSHARelated = SAMSHARelated;
        anObject.AuthorQueryNeeded = AuthorQueryNeeded != "False";
        anObject.RecommendReview = RecommendReview != "False";
        anObject.Notes = Notes;
        anObject.DocumentId = DocumentId;

        return anObject;
    }

    function makeOutcomeRecord(OutcomeId, StudyId, Measure, PopDescrip) {
        var anObject = {};

        anObject.Id = OutcomeId;
        anObject.StudyId = StudyId;
        anObject.Measure = Measure;
        anObject.PopDescrip = PopDescrip;

        return anObject;
    }

    @foreach(NREPPAdminSite.Models.Study item in Model.StudyDocuments)
    {
        @:currentStudy.push(makeRecord(@item.Id, @item.StudyId, '@item.Reference', "@item.inLitSearch", @item.Exclusion1, @item.Exclusion2, @item.Exclusion3, @item.StudyDesign, '@item.BaselineEquiv', "@item.UseMultivariate", @item.SAMSHARelated, "@item.AuthorQueryNeeded", "@item.RecommendReview", "@item.Notes", @item.DocumentId));
    }

    @foreach(NREPPAdminSite.Models.OutcomeMeasure om in Model.Outcomes.OutcomesMeasures)
    {
        @:currentOutcomes.push(makeOutcomeRecord(@om.Id, @om.StudyId, "@om.OutcomeMeasureName", "@om.PopDescription"));
    }


</script>

